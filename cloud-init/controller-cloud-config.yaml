#cloud-config
runcmd:
 # Note: Don't write files to /tmp from cloud-init use /run/somedir instead.
 # Early boot environments can race systemd-tmpfiles-clean LP: #1707222.
 - local json=$(cat /var/lib/cloud/instance/conf_location_details.json)
 - export confLocation=$(echo $json | jq -r .confLocation)
 - export artifactsSasToken=$(echo $json | jq -r .artifactsSasToken)
 - export httpsTermination=$(echo $json | jq -r .httpsTermination)
 - export moodleStackConfigurationDownloadPath=$(echo $json | jq -r .moodleStackConfigurationDownloadPath)
 - mkdir $moodleStackConfigurationDownloadPath
 - moodleVcl = "${confLocation}moodle.vcl${artifactsSasToken}"
 - [ wget, $moodleVcl}, -O, ${moodleStackConfigurationDownloadPath}/moodle.vcl ]
 - if [ "$httpsTermination" = "None" ]; then nginxConfUri = "${confLocation}nginx-httpsTermination-none.conf${artifactsSasToken}"; else nginxConfUri = "${confLocation}nginx-httpsTermination-default.conf${artifactsSasToken}"; fi
 - [ wget, $nginxConfUri, -O, ${moodleStackConfigurationDownloadPath}/nginx.conf ]
 - if [ "$httpsTermination" = "VMSS" ]; then siteFqdn = "${confLocation}siteFQDN-httpsTermination-vmss.conf${artifactsSasToken}"; elif [ "$httpsTermination" = "None" ]; siteFqdn = "${confLocation}siteFQDN-httpsTermination-none.conf${artifactsSasToken}"; else siteFqdn = "${confLocation}siteFQDN-httpsTermination-default.conf${artifactsSasToken}"; fi
 - [ wget, $siteFqdn, -O, ${moodleStackConfigurationDownloadPath}/siteFqdn.conf ]